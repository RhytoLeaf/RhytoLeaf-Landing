<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zeek — RSVP Speed Reader</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'serif': ['Libre Baskerville', 'Georgia', 'serif'],
            'mono': ['Space Mono', 'monospace'],
          },
          colors: {
            'zeek': {
              'bg': '#0a0a0a',
              'surface': '#141414',
              'border': '#2a2a2a',
              'text': '#e8e8e8',
              'muted': '#6b6b6b',
              'accent': '#e63946',
            }
          }
        }
      }
    }
  </script>
  <style>
    * { box-sizing: border-box; }
    body { 
      background: #0a0a0a; 
      color: #e8e8e8;
      font-family: 'Space Mono', monospace;
    }
    
    /* Safe area insets for notch/home indicator */
    @supports (padding: env(safe-area-inset-bottom)) {
      .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    }
    
    /* Portrait mode optimizations */
    .portrait-mode .reader-controls {
      flex-direction: column-reverse;
      gap: 1rem;
    }
    .portrait-mode .speed-dial-container {
      width: 100%;
      padding: 0 1rem;
    }
    .portrait-mode .volume-bar-wrapper {
      width: 100%;
    }
    .portrait-mode #volumeBarTrack {
      flex: 1;
      width: auto;
    }
    .portrait-mode .playback-controls {
      justify-content: space-around;
      width: 100%;
      padding: 0.5rem 0;
    }
    .portrait-mode .queue-word {
      padding: 0.5rem 0.75rem;
      min-width: 44px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .portrait-mode #wordQueue {
      gap: 0.5rem;
      padding: 0.75rem 1rem;
    }
    .portrait-mode #wpmDisplay {
      position: static;
      text-align: center;
      font-size: 1.25rem;
      margin-top: 1rem;
    }
    .portrait-mode .orp-word {
      font-size: clamp(2rem, 12vw, 4rem);
    }
    .portrait-mode #playPauseBtn {
      width: 72px;
      height: 72px;
    }
    .portrait-mode #playPauseBtn svg {
      width: 36px;
      height: 36px;
    }
    .portrait-mode #rewindBtn,
    .portrait-mode #forwardBtn {
      padding: 1rem;
    }
    .portrait-mode #rewindBtn svg,
    .portrait-mode #forwardBtn svg {
      width: 28px;
      height: 28px;
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #141414; }
    ::-webkit-scrollbar-thumb { background: #2a2a2a; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #3a3a3a; }
    
    /* ORP word display */
    .orp-word {
      font-family: 'Libre Baskerville', serif;
      font-size: clamp(2.5rem, 8vw, 5rem);
      letter-spacing: 0.02em;
      line-height: 1.2;
    }
    
    .orp-letter { color: #e63946; }
    
    /* Focus guides */
    .focus-line {
      position: absolute;
      background: #2a2a2a;
    }
    .focus-line-v { width: 1px; height: 40px; }
    .focus-line-h { height: 1px; width: 100%; }
    
    /* Word queue */
    .queue-word {
      transition: all 0.15s ease-out;
    }
    .queue-word:hover {
      color: #e8e8e8;
    }
    
    /* Volume bar dial */
    #volumeBarTrack {
      background: #2a2a2a;
    }
    #volumeBarFill {
      background: linear-gradient(90deg, #e63946 0%, #ff6b6b 100%);
      transition: width 0.05s ease-out;
    }
    #volumeBarThumb {
      transition: transform 0.1s ease;
      box-shadow: 0 2px 8px rgba(230, 57, 70, 0.4);
    }
    #volumeBarThumb:hover {
      transform: translateY(-50%) scale(1.1);
    }
    
    /* Camera viewfinder */
    .viewfinder-guide {
      border: 2px dashed rgba(230, 57, 70, 0.6);
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    .animate-pulse-slow { animation: pulse 2s ease-in-out infinite; }
    
    /* Progress bar */
    .progress-track { background: #2a2a2a; }
    .progress-fill { background: #e63946; transition: width 0.1s linear; }
    
    /* Textarea */
    textarea::placeholder { color: #4a4a4a; }
    textarea:focus { outline: none; border-color: #e63946; }
    
    /* Button states */
    .btn-primary {
      background: #e63946;
      transition: all 0.2s ease;
    }
    .btn-primary:hover { background: #ff4d5a; transform: translateY(-1px); }
    .btn-primary:active { transform: translateY(0); }
    
    .btn-secondary {
      background: #2a2a2a;
      transition: all 0.2s ease;
    }
    .btn-secondary:hover { background: #3a3a3a; }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- ==================== INPUT VIEW ==================== -->
  <div id="inputView" class="flex-1 flex flex-col items-center justify-center p-6">
    <header class="mb-8 text-center animate-fade-in">
      <h1 class="text-4xl md:text-5xl font-serif font-bold tracking-tight mb-2">
        Z<span class="text-zeek-accent">e</span>ek
      </h1>
      <p class="text-zeek-muted text-sm">RSVP Speed Reader</p>
    </header>
    
    <div class="w-full max-w-2xl animate-fade-in" style="animation-delay: 0.1s;">
      <div class="relative">
        <textarea 
          id="textInput"
          class="w-full h-48 md:h-64 bg-zeek-surface border border-zeek-border rounded-lg p-4 pb-12 text-zeek-text font-mono text-sm resize-none"
          placeholder="Paste your text here..."
        ></textarea>
        <button 
          id="pasteBtn"
          class="absolute bottom-3 right-3 flex items-center gap-1.5 px-3 py-1.5 bg-zeek-border hover:bg-zeek-muted/40 rounded-md text-zeek-muted hover:text-zeek-text transition-colors text-xs font-mono"
          title="Paste from clipboard"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
          </svg>
          Paste
        </button>
      </div>
      
      <div class="flex flex-col sm:flex-row gap-3 mt-4">
        <button 
          id="scanBtn"
          class="btn-secondary flex-1 py-3 px-6 rounded-lg font-mono text-sm flex items-center justify-center gap-2"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          Scan Text
        </button>
        
        <button 
          id="zeekBtn"
          class="btn-primary flex-1 py-3 px-6 rounded-lg font-mono text-sm font-bold"
        >
          Zeek →
        </button>
      </div>
      
      <p class="text-zeek-muted text-xs text-center mt-4">
        Designed to help with dyslexia, ADHD & visual processing
      </p>
    </div>
    
    <footer class="py-4 text-center">
      <p class="text-zeek-muted text-xs">&copy; RhytoLeaf Inc. All Rights Reserved</p>
    </footer>
  </div>

  <!-- ==================== CAMERA MODAL ==================== -->
  <div id="cameraModal" class="fixed inset-0 bg-black z-50 hidden flex-col">
    <div class="flex items-center justify-between p-4 bg-zeek-surface border-b border-zeek-border">
      <h2 class="font-mono text-sm">Scan Document</h2>
      <button id="closeCameraBtn" class="p-2 hover:bg-zeek-border rounded-lg transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    
    <div class="flex-1 relative overflow-hidden">
      <video id="cameraFeed" class="w-full h-full object-cover" autoplay playsinline></video>
      
      <!-- Viewfinder guide -->
      <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
        <div class="viewfinder-guide w-[85%] h-[40%] rounded-lg"></div>
      </div>
      
      <!-- Processing overlay -->
      <div id="processingOverlay" class="absolute inset-0 bg-black/80 hidden flex-col items-center justify-center">
        <div class="w-16 h-16 border-4 border-zeek-accent border-t-transparent rounded-full animate-spin mb-4"></div>
        <p id="processingStatus" class="font-mono text-sm text-zeek-muted">Initializing OCR...</p>
        <p id="processingPercent" class="font-mono text-2xl text-zeek-accent mt-2">0%</p>
      </div>
    </div>
    
    <div class="p-4 bg-zeek-surface border-t border-zeek-border flex items-center justify-center gap-4">
      <button id="torchBtn" class="p-3 bg-zeek-border rounded-full hover:bg-zeek-muted/30 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
        </svg>
      </button>
      
      <button id="captureBtn" class="p-4 bg-zeek-accent rounded-full hover:bg-red-500 transition-colors">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
      </button>
      
      <button id="switchCameraBtn" class="p-3 bg-zeek-border rounded-full hover:bg-zeek-muted/30 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
      </button>
    </div>
    
    <!-- Hidden canvas for capture -->
    <canvas id="captureCanvas" class="hidden"></canvas>
  </div>

  <!-- ==================== READER VIEW ==================== -->
  <div id="readerView" class="fixed inset-0 bg-zeek-bg hidden flex-col">
    <!-- Top bar -->
    <div class="flex items-center justify-between p-4 border-b border-zeek-border">
      <button id="backBtn" class="p-2 hover:bg-zeek-border rounded-lg transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
        </svg>
      </button>
      
      <div class="flex items-center gap-2">
        <span id="wordCounter" class="font-mono text-xs text-zeek-muted">0 / 0</span>
      </div>
      
      <button id="portraitToggle" class="p-2 hover:bg-zeek-border rounded-lg transition-colors" title="Toggle portrait mode">
        <svg id="portraitIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
        </svg>
        <svg id="landscapeIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
        </svg>
      </button>
    </div>
    
    <!-- Main reading area -->
    <div id="swipeArea" class="flex-1 flex flex-col items-center justify-center relative px-4">
      <!-- Focus guides -->
      <div class="focus-line focus-line-v absolute top-4" style="left: 50%;"></div>
      <div class="focus-line focus-line-v absolute bottom-4" style="left: 50%;"></div>
      
      <!-- Word display -->
      <div id="wordDisplay" class="orp-word text-zeek-text text-center select-none">
        Ready
      </div>
      
      <!-- WPM indicator -->
      <div id="wpmDisplay" class="absolute bottom-8 right-8 font-mono text-sm text-zeek-muted">
        300 wpm
      </div>
    </div>
    
    <!-- Word queue -->
    <div class="border-t border-zeek-border bg-zeek-surface">
      <div id="wordQueue" class="flex items-center justify-center gap-3 py-3 px-4 overflow-x-auto">
        <!-- Queue words will be inserted here -->
      </div>
    </div>
    
    <!-- Progress bar (draggable) -->
    <div class="px-4 py-2 bg-zeek-surface border-t border-zeek-border">
      <div 
        id="progressTrack" 
        class="progress-track h-2 rounded-full cursor-pointer relative"
      >
        <div id="progressFill" class="progress-fill h-full rounded-full" style="width: 0%;"></div>
        <div 
          id="progressThumb" 
          class="absolute top-1/2 -translate-y-1/2 w-4 h-4 bg-zeek-accent rounded-full shadow-lg cursor-grab active:cursor-grabbing"
          style="left: 0%;"
        ></div>
      </div>
    </div>
    
    <!-- Controls -->
    <div class="p-4 bg-zeek-surface border-t border-zeek-border safe-bottom">
      <div class="reader-controls flex flex-col items-center gap-4">
        <div class="playback-controls flex items-center justify-center gap-6">
          <!-- Rewind -->
          <button id="rewindBtn" class="p-2 hover:bg-zeek-border rounded-lg transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0019 16V8a1 1 0 00-1.6-.8l-5.333 4zM4.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0011 16V8a1 1 0 00-1.6-.8l-5.334 4z"/>
            </svg>
          </button>
          
          <!-- Play/Pause -->
          <button id="playPauseBtn" class="p-4 bg-zeek-accent rounded-full hover:bg-red-500 transition-colors flex items-center justify-center">
            <svg id="playIcon" class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
              <path d="M8 5v14l11-7z"/>
            </svg>
            <svg id="pauseIcon" class="w-8 h-8 hidden" fill="currentColor" viewBox="0 0 24 24">
              <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
            </svg>
          </button>
          
          <!-- Forward -->
          <button id="forwardBtn" class="p-2 hover:bg-zeek-border rounded-lg transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.933 12.8a1 1 0 000-1.6L6.6 7.2A1 1 0 005 8v8a1 1 0 001.6.8l5.333-4zM19.933 12.8a1 1 0 000-1.6l-5.333-4A1 1 0 0013 8v8a1 1 0 001.6.8l5.333-4z"/>
            </svg>
          </button>
        </div>
        
        <!-- Speed dial - Volume Bar -->
        <div class="speed-dial-container flex flex-col items-center justify-center gap-2">
          <span class="font-mono text-xs text-zeek-muted">WPM</span>
          <div class="volume-bar-wrapper flex items-center gap-3">
            <span class="font-mono text-xs text-zeek-muted w-8 text-right">300</span>
            <div id="volumeBarTrack" class="relative w-48 h-3 bg-zeek-border rounded-full cursor-pointer">
              <div id="volumeBarFill" class="absolute left-0 top-0 h-full bg-zeek-accent rounded-full" style="width: 0%;"></div>
              <div id="volumeBarThumb" class="absolute top-1/2 -translate-y-1/2 w-5 h-5 bg-zeek-accent rounded-full shadow-lg cursor-grab active:cursor-grabbing border-2 border-zeek-bg" style="left: 0%;"></div>
            </div>
            <span class="font-mono text-xs text-zeek-muted w-8">900</span>
          </div>
          <span id="dialValueText" class="font-mono text-lg text-zeek-text font-bold">300</span>
        </div>
      </div>
      
      <p class="text-zeek-muted text-xs text-center mt-4">&copy; RhytoLeaf Inc. All Rights Reserved</p>
    </div>
  </div>

  <script>
    // ==================== STATE ====================
    const state = {
      words: [],
      currentIndex: 0,
      isPlaying: false,
      wpm: 300,
      intervalId: null,
      cameraStream: null,
      torchEnabled: false,
      facingMode: 'environment',
      portraitMode: false,
      touchStartX: 0,
      touchStartY: 0
    };

    // ==================== DOM REFS ====================
    const dom = {
      // Views
      inputView: document.getElementById('inputView'),
      cameraModal: document.getElementById('cameraModal'),
      readerView: document.getElementById('readerView'),
      
      // Input view
      textInput: document.getElementById('textInput'),
      scanBtn: document.getElementById('scanBtn'),
      zeekBtn: document.getElementById('zeekBtn'),
      pasteBtn: document.getElementById('pasteBtn'),
      
      // Camera modal
      cameraFeed: document.getElementById('cameraFeed'),
      captureCanvas: document.getElementById('captureCanvas'),
      closeCameraBtn: document.getElementById('closeCameraBtn'),
      torchBtn: document.getElementById('torchBtn'),
      captureBtn: document.getElementById('captureBtn'),
      switchCameraBtn: document.getElementById('switchCameraBtn'),
      processingOverlay: document.getElementById('processingOverlay'),
      processingStatus: document.getElementById('processingStatus'),
      processingPercent: document.getElementById('processingPercent'),
      
      // Reader view
      backBtn: document.getElementById('backBtn'),
      wordDisplay: document.getElementById('wordDisplay'),
      wpmDisplay: document.getElementById('wpmDisplay'),
      wordCounter: document.getElementById('wordCounter'),
      wordQueue: document.getElementById('wordQueue'),
      progressTrack: document.getElementById('progressTrack'),
      progressFill: document.getElementById('progressFill'),
      progressThumb: document.getElementById('progressThumb'),
      playPauseBtn: document.getElementById('playPauseBtn'),
      playIcon: document.getElementById('playIcon'),
      pauseIcon: document.getElementById('pauseIcon'),
      rewindBtn: document.getElementById('rewindBtn'),
      forwardBtn: document.getElementById('forwardBtn'),
      volumeBarTrack: document.getElementById('volumeBarTrack'),
      volumeBarFill: document.getElementById('volumeBarFill'),
      volumeBarThumb: document.getElementById('volumeBarThumb'),
      dialValueText: document.getElementById('dialValueText'),
      portraitToggle: document.getElementById('portraitToggle'),
      portraitIcon: document.getElementById('portraitIcon'),
      landscapeIcon: document.getElementById('landscapeIcon'),
      swipeArea: document.getElementById('swipeArea')
    };

    // ==================== ORP CALCULATION ====================
    /**
     * Calculate Optimal Recognition Point for a word.
     * Research shows eyes fixate ~20-35% from left.
     */
    function getORPIndex(word) {
      const len = word.length;
      if (len <= 1) return 0;
      if (len <= 5) return 1;
      if (len <= 9) return 2;
      if (len <= 13) return 3;
      return 4;
    }

    /**
     * Render word with ORP letter highlighted in red.
     * Returns HTML string with the ORP letter wrapped in span.
     */
    function renderORPWord(word) {
      if (!word) return '';
      const orpIndex = getORPIndex(word);
      const before = word.slice(0, orpIndex);
      const orp = word[orpIndex] || '';
      const after = word.slice(orpIndex + 1);
      return `${escapeHtml(before)}<span class="orp-letter">${escapeHtml(orp)}</span>${escapeHtml(after)}`;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ==================== TEXT PROCESSING ====================
    function parseText(text) {
      // Split on whitespace, filter empty strings
      return text.trim().split(/\s+/).filter(w => w.length > 0);
    }

    // ==================== VIEW MANAGEMENT ====================
    function showInputView() {
      stopPlayback();
      dom.inputView.classList.remove('hidden');
      dom.inputView.classList.add('flex');
      dom.readerView.classList.add('hidden');
      dom.cameraModal.classList.add('hidden');
    }

    function showReaderView() {
      dom.inputView.classList.add('hidden');
      dom.inputView.classList.remove('flex');
      dom.readerView.classList.remove('hidden');
      dom.readerView.classList.add('flex');
      dom.cameraModal.classList.add('hidden');
    }

    function showCameraModal() {
      dom.cameraModal.classList.remove('hidden');
      dom.cameraModal.classList.add('flex');
      startCamera();
    }

    function hideCameraModal() {
      dom.cameraModal.classList.add('hidden');
      dom.cameraModal.classList.remove('flex');
      stopCamera();
    }

    // ==================== READER LOGIC ====================
    function initReader(text) {
      state.words = parseText(text);
      if (state.words.length === 0) {
        alert('Please enter some text to read.');
        return;
      }
      state.currentIndex = 0;
      state.isPlaying = false;
      updateDisplay();
      updateVolumeBar(state.wpm);
      showReaderView();
    }

    function updateDisplay() {
      const word = state.words[state.currentIndex] || '';
      dom.wordDisplay.innerHTML = renderORPWord(word);
      
      // Update counter
      dom.wordCounter.textContent = `${state.currentIndex + 1} / ${state.words.length}`;
      
      // Update progress
      const progress = state.words.length > 1 
        ? (state.currentIndex / (state.words.length - 1)) * 100 
        : 0;
      dom.progressFill.style.width = `${progress}%`;
      dom.progressThumb.style.left = `calc(${progress}% - 8px)`;
      
      // Update queue
      updateWordQueue();
    }

    function updateWordQueue() {
      const queueSize = 4;
      let html = '';
      
      // Previous words
      for (let i = state.currentIndex - queueSize; i < state.currentIndex; i++) {
        if (i >= 0 && state.words[i]) {
          html += `<span class="queue-word font-mono text-xs text-zeek-muted cursor-pointer hover:text-zeek-text" data-index="${i}">${escapeHtml(state.words[i])}</span>`;
        }
      }
      
      // Current word
      html += `<span class="queue-word font-mono text-sm text-zeek-accent font-bold">${escapeHtml(state.words[state.currentIndex] || '')}</span>`;
      
      // Next words
      for (let i = state.currentIndex + 1; i <= state.currentIndex + queueSize; i++) {
        if (i < state.words.length && state.words[i]) {
          html += `<span class="queue-word font-mono text-xs text-zeek-muted cursor-pointer hover:text-zeek-text" data-index="${i}">${escapeHtml(state.words[i])}</span>`;
        }
      }
      
      dom.wordQueue.innerHTML = html;
      
      // Add click handlers to queue words
      dom.wordQueue.querySelectorAll('[data-index]').forEach(el => {
        el.addEventListener('click', () => {
          state.currentIndex = parseInt(el.dataset.index, 10);
          updateDisplay();
        });
      });
    }

    function startPlayback() {
      if (state.isPlaying) return;
      state.isPlaying = true;
      dom.playIcon.classList.add('hidden');
      dom.pauseIcon.classList.remove('hidden');
      
      const msPerWord = 60000 / state.wpm;
      state.intervalId = setInterval(() => {
        if (state.currentIndex < state.words.length - 1) {
          state.currentIndex++;
          updateDisplay();
        } else {
          stopPlayback();
        }
      }, msPerWord);
    }

    function stopPlayback() {
      state.isPlaying = false;
      dom.playIcon.classList.remove('hidden');
      dom.pauseIcon.classList.add('hidden');
      if (state.intervalId) {
        clearInterval(state.intervalId);
        state.intervalId = null;
      }
    }

    function togglePlayback() {
      if (state.isPlaying) {
        stopPlayback();
      } else {
        startPlayback();
      }
    }

    function updateWPM(wpm) {
      state.wpm = parseInt(wpm, 10);
      dom.wpmDisplay.textContent = `${state.wpm} wpm`;
      
      // Restart playback with new speed if playing
      if (state.isPlaying) {
        stopPlayback();
        startPlayback();
      }
    }

    // ==================== CAMERA / OCR ====================
    async function startCamera() {
      try {
        const constraints = {
          video: {
            facingMode: state.facingMode,
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        };
        
        state.cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
        dom.cameraFeed.srcObject = state.cameraStream;
      } catch (err) {
        console.error('Camera error:', err);
        alert('Could not access camera. Please check permissions.');
        hideCameraModal();
      }
    }

    function stopCamera() {
      if (state.cameraStream) {
        state.cameraStream.getTracks().forEach(track => track.stop());
        state.cameraStream = null;
      }
      state.torchEnabled = false;
    }

    async function toggleTorch() {
      if (!state.cameraStream) return;
      
      const track = state.cameraStream.getVideoTracks()[0];
      const capabilities = track.getCapabilities();
      
      if (!capabilities.torch) {
        alert('Torch not available on this device');
        return;
      }
      
      state.torchEnabled = !state.torchEnabled;
      await track.applyConstraints({
        advanced: [{ torch: state.torchEnabled }]
      });
      
      dom.torchBtn.classList.toggle('bg-zeek-accent', state.torchEnabled);
    }

    async function switchCamera() {
      stopCamera();
      state.facingMode = state.facingMode === 'environment' ? 'user' : 'environment';
      await startCamera();
    }

    async function captureAndProcess() {
      // Capture frame to canvas
      const video = dom.cameraFeed;
      const canvas = dom.captureCanvas;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);
      
      // Show processing overlay
      dom.processingOverlay.classList.remove('hidden');
      dom.processingOverlay.classList.add('flex');
      dom.processingStatus.textContent = 'Initializing OCR...';
      dom.processingPercent.textContent = '0%';
      
      try {
        // Run Tesseract OCR
        const result = await Tesseract.recognize(
          canvas,
          'eng',
          {
            logger: m => {
              if (m.status === 'recognizing text') {
                const percent = Math.round(m.progress * 100);
                dom.processingPercent.textContent = `${percent}%`;
                dom.processingStatus.textContent = 'Recognizing text...';
              } else if (m.status === 'loading language traineddata') {
                dom.processingStatus.textContent = 'Loading language data...';
              }
            }
          }
        );
        
        const text = result.data.text.trim();
        
        if (text) {
          dom.textInput.value = text;
          hideCameraModal();
        } else {
          alert('No text detected. Try adjusting lighting or position.');
        }
      } catch (err) {
        console.error('OCR error:', err);
        alert('OCR failed. Please try again.');
      } finally {
        dom.processingOverlay.classList.add('hidden');
        dom.processingOverlay.classList.remove('flex');
      }
    }

    // ==================== PROGRESS BAR DRAGGING ====================
    function setupProgressDrag() {
      let isDragging = false;
      
      function updateFromPosition(clientX) {
        const rect = dom.progressTrack.getBoundingClientRect();
        let percent = (clientX - rect.left) / rect.width;
        percent = Math.max(0, Math.min(1, percent));
        state.currentIndex = Math.round(percent * (state.words.length - 1));
        updateDisplay();
      }
      
      dom.progressTrack.addEventListener('mousedown', (e) => {
        isDragging = true;
        updateFromPosition(e.clientX);
      });
      
      dom.progressThumb.addEventListener('mousedown', (e) => {
        isDragging = true;
        e.stopPropagation();
      });
      
      document.addEventListener('mousemove', (e) => {
        if (isDragging) {
          updateFromPosition(e.clientX);
        }
      });
      
      document.addEventListener('mouseup', () => {
        isDragging = false;
      });
      
      // Touch support
      dom.progressTrack.addEventListener('touchstart', (e) => {
        isDragging = true;
        updateFromPosition(e.touches[0].clientX);
      });
      
      dom.progressThumb.addEventListener('touchstart', (e) => {
        isDragging = true;
        e.stopPropagation();
      });
      
      document.addEventListener('touchmove', (e) => {
        if (isDragging) {
          updateFromPosition(e.touches[0].clientX);
        }
      });
      
      document.addEventListener('touchend', () => {
        isDragging = false;
      });
    }

    // ==================== VOLUME BAR DIAL ====================
    function updateVolumeBar(wpm) {
      const percent = ((wpm - 300) / 600) * 100;
      dom.volumeBarFill.style.width = `${percent}%`;
      dom.volumeBarThumb.style.left = `calc(${percent}% - 10px)`;
      dom.dialValueText.textContent = wpm;
    }
    
    function setupArcDial() {
      let isDragging = false;
      
      function getWPMFromPosition(clientX) {
        const rect = dom.volumeBarTrack.getBoundingClientRect();
        let percent = (clientX - rect.left) / rect.width;
        percent = Math.max(0, Math.min(1, percent));
        return Math.round(300 + percent * 600);
      }
      
      function handleDrag(e) {
        if (!isDragging) return;
        e.preventDefault();
        
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const wpm = getWPMFromPosition(clientX);
        
        state.wpm = wpm;
        updateWPM(wpm);
        updateVolumeBar(wpm);
      }
      
      // Mouse events
      dom.volumeBarTrack.addEventListener('mousedown', (e) => {
        isDragging = true;
        handleDrag(e);
      });
      
      dom.volumeBarThumb.addEventListener('mousedown', (e) => {
        isDragging = true;
        e.stopPropagation();
      });
      
      document.addEventListener('mousemove', handleDrag);
      document.addEventListener('mouseup', () => { isDragging = false; });
      
      // Touch events
      dom.volumeBarTrack.addEventListener('touchstart', (e) => {
        isDragging = true;
        handleDrag(e);
      });
      
      dom.volumeBarThumb.addEventListener('touchstart', (e) => {
        isDragging = true;
        e.stopPropagation();
      });
      
      document.addEventListener('touchmove', (e) => {
        if (isDragging) handleDrag(e);
      }, { passive: false });
      
      document.addEventListener('touchend', () => { isDragging = false; });
      
      // Initialize
      updateVolumeBar(state.wpm);
    }

    // ==================== PORTRAIT MODE ====================
    function togglePortraitMode() {
      state.portraitMode = !state.portraitMode;
      
      if (state.portraitMode) {
        dom.readerView.classList.add('portrait-mode');
        dom.portraitIcon.classList.add('hidden');
        dom.landscapeIcon.classList.remove('hidden');
      } else {
        dom.readerView.classList.remove('portrait-mode');
        dom.portraitIcon.classList.remove('hidden');
        dom.landscapeIcon.classList.add('hidden');
      }
    }
    
    // ==================== SWIPE GESTURES ====================
    function setupSwipeGestures() {
      const minSwipeDistance = 50;
      
      dom.swipeArea.addEventListener('touchstart', (e) => {
        state.touchStartX = e.touches[0].clientX;
        state.touchStartY = e.touches[0].clientY;
      }, { passive: true });
      
      dom.swipeArea.addEventListener('touchend', (e) => {
        const touchEndX = e.changedTouches[0].clientX;
        const touchEndY = e.changedTouches[0].clientY;
        
        const deltaX = touchEndX - state.touchStartX;
        const deltaY = touchEndY - state.touchStartY;
        
        // Only register horizontal swipes (ignore vertical scrolling)
        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > minSwipeDistance) {
          if (deltaX > 0) {
            // Swipe right - previous word
            state.currentIndex = Math.max(0, state.currentIndex - 1);
          } else {
            // Swipe left - next word
            state.currentIndex = Math.min(state.words.length - 1, state.currentIndex + 1);
          }
          updateDisplay();
        }
      }, { passive: true });
      
      // Tap to play/pause
      dom.swipeArea.addEventListener('click', (e) => {
        // Only toggle if not dragging progress
        if (e.target === dom.swipeArea || e.target === dom.wordDisplay || e.target.closest('#wordDisplay')) {
          togglePlayback();
        }
      });
    }

    // ==================== KEYBOARD SHORTCUTS ====================
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        if (dom.readerView.classList.contains('hidden')) return;
        if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
        
        switch (e.code) {
          case 'Space':
            e.preventDefault();
            togglePlayback();
            break;
          case 'ArrowLeft':
            e.preventDefault();
            state.currentIndex = Math.max(0, state.currentIndex - 1);
            updateDisplay();
            break;
          case 'ArrowRight':
            e.preventDefault();
            state.currentIndex = Math.min(state.words.length - 1, state.currentIndex + 1);
            updateDisplay();
            break;
          case 'ArrowUp':
            e.preventDefault();
            state.wpm = Math.min(900, state.wpm + 1);
            updateWPM(state.wpm);
            updateVolumeBar(state.wpm);
            break;
          case 'ArrowDown':
            e.preventDefault();
            state.wpm = Math.max(300, state.wpm - 1);
            updateWPM(state.wpm);
            updateVolumeBar(state.wpm);
            break;
          case 'KeyP':
            e.preventDefault();
            togglePortraitMode();
            break;
          case 'Escape':
            showInputView();
            break;
        }
      });
    }

    // ==================== EVENT LISTENERS ====================
    function init() {
      // Input view
      dom.zeekBtn.addEventListener('click', () => {
        initReader(dom.textInput.value);
      });
      
      dom.scanBtn.addEventListener('click', showCameraModal);
      
      dom.pasteBtn.addEventListener('click', async () => {
        try {
          const text = await navigator.clipboard.readText();
          dom.textInput.value = text;
          dom.textInput.focus();
        } catch (err) {
          // Fallback: focus textarea and prompt manual paste
          dom.textInput.focus();
          alert('Clipboard access denied. Please use Ctrl+V / Cmd+V to paste.');
        }
      });
      
      // Camera modal
      dom.closeCameraBtn.addEventListener('click', hideCameraModal);
      dom.torchBtn.addEventListener('click', toggleTorch);
      dom.switchCameraBtn.addEventListener('click', switchCamera);
      dom.captureBtn.addEventListener('click', captureAndProcess);
      
      // Reader view
      dom.backBtn.addEventListener('click', showInputView);
      dom.playPauseBtn.addEventListener('click', togglePlayback);
      
      dom.rewindBtn.addEventListener('click', () => {
        state.currentIndex = Math.max(0, state.currentIndex - 10);
        updateDisplay();
      });
      
      dom.forwardBtn.addEventListener('click', () => {
        state.currentIndex = Math.min(state.words.length - 1, state.currentIndex + 10);
        updateDisplay();
      });
      
      dom.portraitToggle.addEventListener('click', togglePortraitMode);
      
      setupProgressDrag();
      setupKeyboardShortcuts();
      setupSwipeGestures();
      setupArcDial();
      
      // Sample text removed - textarea starts empty
    }

    // Initialize on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
